global:
  smtp_smarthost: 172.30.186.77:1025
  smtp_from: {{ .SMTPFrom  }}
  smtp_require_tls: false

templates:
  - /etc/alertmanager/config/alertmanager-email-config.tmpl

route:
    receiver: 'default'
    routes:
    - receiver: critical
      match:
        severity: critical
    - match:
        alertname: DeadMansSwitch
      repeat_interval: 5m
      receiver: deadmansswitch
    - receiver: BUandCustomer
      match:
        alertname: RHOAMApiUsageLevel1ThresholdExceeded
    - receiver: BUandCustomer
      match:
        alertname: RHOAMApiUsageLevel2ThresholdExceeded
    - receiver: SRECustomerBU
      match:
        alertname: RHOAMApiUsageLevel3ThresholdExceeded
    - receiver: BU
      match_re:
        alertname: RHOAMApiUsageSoftLimitReachedTier[0-9]+
    - receiver: BUandCustomer
      match:
        alertname: RHOAMApiUsageOverLimit
    - receiver: SRECustomerBU
      match:
        alertname: RHOAMApiUsageRejectedRequestsMismatch
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 12h

receivers:
    - name: 'default'
      email_configs:
      - to: {{ .SMTPToSREAddress }}
        headers:
          Subject: '{{ .EmailSubject }}'
        html: '{{ .EmailTemplateFile }}'
    - name: critical
      pagerduty_configs:
        - service_key: {{ .PagerDutyServiceKey }}
          description: '{{ .EmailSubject }}'
          details:
            cluster_name: {{ .ClusterName }}
            cluster_ID: {{ .ClusterID }}
            console: {{ .ClusterConsole }}
      email_configs:
      - to: {{ .SMTPToSREAddress }}
        headers:
          Subject: '{{ .EmailSubject }}'
        html: '{{ .EmailTemplateFile }}'
    - name: deadmansswitch
      webhook_configs:
        - url: {{ .DeadMansSnitchURL }}
    - name: BU
      email_configs:
      - to: {{ .SMTPToBUAddress }}
        headers:
          Subject: '{{ .EmailSubject }}'
        html: '{{ .EmailTemplateFile }}'
    - name: BUandCustomer
      email_configs:
      - to: {{ .SMTPToSREAddress }}, {{ .SMTPToCustomerAddress }}
        headers:
          Subject: '{{ .EmailSubject }}'
        html: '{{ .EmailTemplateFile }}'
    - name: SRECustomerBU
      email_configs:
      - to: {{ .SMTPToSREAddress }}, {{ .SMTPToBUAddress }}, {{ .SMTPToCustomerAddress }}
        headers:
          Subject: '{{ .EmailSubject }}'
        html: '{{ .EmailTemplateFile }}'


inhibit_rules:
  - source_match:
      alertname: 'JobRunningTimeExceeded'
      severity: 'warning'
    target_match:
      alertname: 'JobRunningTimeExceeded'
      severity: 'warning'
    equal: ['alertname', 'job', 'label_cronjob_name']